# TON Wallet Connection Implementation

This document provides an overview of the TON wallet connection implementation in the Hashland API, following the [TON Connect documentation](https://docs.ton.org/v3/guidelines/ton-connect/guidelines/verifying-signed-in-users).

## Flow Overview

The implementation follows these steps:

1. DApp (frontend) requests a payload token from the server
2. Server generates a random payload and wraps it in a JWT token
3. DApp connects to wallet using the payload and receives a signed `ton_proof`
4. DApp sends the signed `ton_proof` to server for verification
5. Server verifies the proof and connects the wallet to the operator

## API Endpoints

### Generate TON Proof Payload

```
POST /operators/wallets/generate-ton-proof-payload
```

This endpoint generates a payload token for TON wallet verification.

**Request Body:**
```json
{
  "context": {
    "user_id": "123456"
  }
}
```

**Response:**
```json
{
  "statusCode": 200,
  "message": "TON proof payload generated",
  "data": {
    "payload": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### Connect TON Wallet

```
POST /operators/wallets/connect-ton
```

This endpoint connects a TON wallet to the authenticated operator using TON proof verification.

**Request Body:**
```json
{
  "address": "EQAbc123...",
  "public_key": "39d0939e8fa4c61854263d8cc71de4d6c90af169958d30f11fafefec1f428ce0",
  "proof": {
    "timestamp": 1646146412,
    "domain": {
      "lengthBytes": 17,
      "value": "hashland.ton.app"
    },
    "signature": "base64-encoded-signature",
    "payload": "payload-token-value",
    "state_init": "base64-encoded-state-init"
  }
}
```

**Response:**
```json
{
  "statusCode": 200,
  "message": "Wallet connected successfully",
  "data": {
    "_id": "60d21b4667d0d8da05ee0462"
  }
}
```

## TON Proof Verification Logic

The server verifies the TON proof using the following steps:

1. Check that the wallet address matches the claimed address
2. Verify the domain is in the list of allowed domains
3. Verify the timestamp is recent (within the configured timeframe)
4. Verify the payload token (JWT) is valid and not expired
5. Extract the public key from:
   - State init (using the tryParsePublicKey utility for different wallet versions)
   - Smart contract's get_public_key method (using TonClient4)
   - Or use the provided public key
6. Verify that the contract address derived from state init matches the claimed address
7. Verify the signature using the message construction according to TON Connect protocol

## Configuration

The TON wallet connection can be configured with the following environment variables:

- `TON_PROOF_JWT_SECRET`: Secret key for JWT tokens (defaults to `JWT_SECRET` or 'hashland-ton-secret')
- `TON_PROOF_PAYLOAD_TTL`: Time-to-live for payload tokens (default: '20m')
- `TON_PROOF_ALLOWED_DOMAINS`: Comma-separated list of allowed domains (default: the configured domain)
- `TON_PROOF_VALID_TIME_SECONDS`: Time in seconds that a proof remains valid (default: 900 seconds)
- `TON_NETWORK`: Network to use, 'mainnet' or 'testnet' (default: 'mainnet')
- `TON_API_ENDPOINT`: TON API endpoint URL (default based on network: 'https://mainnet-v4.tonhubapi.com' or 'https://testnet-v4.tonhubapi.com')

## Implementation Details

### Client Implementation

The implementation uses TonClient4 from @ton/ton, which provides modern access to the TON blockchain. This is the same client used in the TON documentation examples.

```typescript
const isMainnet = this.configService.get<string>('TON_NETWORK', 'mainnet') === 'mainnet';
const endpoint = isMainnet 
  ? this.configService.get<string>('TON_API_ENDPOINT', 'https://mainnet-v4.tonhubapi.com')
  : this.configService.get<string>('TON_API_ENDPOINT', 'https://testnet-v4.tonhubapi.com');

this.tonClient = new TonClient4({
  endpoint,
});
```

### Public Key Extraction

The implementation includes a utility function to parse public keys from different TON wallet versions:

```typescript
// First, try parsing from state init
publicKey = tryParsePublicKey(stateInit);

// If not found, try getting from contract
if (!publicKey) {
  publicKey = await this.extractPublicKeyFromContract(parsedAddress);
}

// If still not found, use the provided public key
if (!publicKey && tonProofDto.public_key) {
  publicKey = Buffer.from(tonProofDto.public_key, 'hex');
}
```

The `tryParsePublicKey` utility supports various wallet versions (v3R1, v3R2, v4R2, etc.) and handles the different data formats.

### JWT Tokens

The payload for TON proof is wrapped in a JWT token with a configurable expiry time. This adds a layer of security by ensuring that:

1. The payload was generated by our server
2. The payload is only used within a specific timeframe
3. The payload cannot be tampered with

### Security Considerations

- Timestamps are validated to prevent replay attacks
- Domain verification ensures the proof was generated for this specific application
- Public key extraction verifies wallet ownership
- State init verification ensures the contract address matches

## Frontend Integration

To integrate with the frontend, follow these steps:

1. Request a payload token from the `/operators/wallets/generate-ton-proof-payload` endpoint
2. Use the TON Connect library to connect to a wallet with the payload
3. Receive the signed `ton_proof` from the wallet
4. Send the `ton_proof` to the `/operators/wallets/connect-ton` endpoint
5. Receive and store the wallet connection confirmation

## Frontend Integration Example

Here's a complete React example showing how to integrate with the TON wallet connection flow using the `@tonconnect/ui-react` library:

### 1. Install Required Packages

```bash
npm install @tonconnect/ui-react @tonconnect/sdk axios
```

### 2. Create TON Connect Manifest

Create a file named `tonconnect-manifest.json` in your public directory:

```json
{
  "url": "https://yourdapp.com",
  "name": "Your DApp Name",
  "iconUrl": "https://yourdapp.com/logo.png",
  "termsOfUseUrl": "https://yourdapp.com/terms",
  "privacyPolicyUrl": "https://yourdapp.com/privacy"
}
```

### 3. TON Wallet Connection Component

```tsx
import React, { useCallback, useEffect, useState } from 'react';
import { 
  TonConnectButton, 
  useTonConnectUI, 
  useTonAddress, 
  CHAIN 
} from '@tonconnect/ui-react';
import axios from 'axios';

// API service for wallet connection
const api = {
  generatePayload: async () => {
    const response = await axios.post('/api/operators/wallets/generate-ton-proof-payload');
    return response.data.data.payload;
  },
  
  connectTonWallet: async (address: string, publicKey: string, proof: any, token: string) => {
    return axios.post(
      '/api/operators/wallets/connect-ton', 
      {
        address,
        public_key: publicKey,
        proof
      },
      {
        headers: {
          Authorization: `Bearer ${token}`
        }
      }
    );
  }
};

const TonWalletConnect: React.FC = () => {
  const [tonConnectUI] = useTonConnectUI();
  const [connecting, setConnecting] = useState(false);
  const [connected, setConnected] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const userFriendlyAddress = useTonAddress();
  const [authToken, setAuthToken] = useState<string | null>(
    localStorage.getItem('authToken')
  );

  // Handle wallet connection with proof
  const handleConnection = useCallback(async () => {
    if (!tonConnectUI.connected) return;
    
    try {
      setConnecting(true);
      setError(null);
      
      // Get wallet info
      const walletConfig = tonConnectUI.wallet;
      if (!walletConfig) {
        throw new Error('Wallet not connected');
      }
      
      // Check if we received ton_proof from the wallet
      const connectItems = walletConfig.connectItems;
      if (!connectItems?.tonProof) {
        throw new Error('TON proof not provided by wallet');
      }
      
      // Check for ton_proof error
      if ('error' in connectItems.tonProof) {
        throw new Error(
          `Wallet proof error: ${connectItems.tonProof.error.message || 'Unknown error'}`
        );
      }
      
      // Extract proof, address and public key
      const proof = connectItems.tonProof.proof;
      const account = walletConfig.account;
      
      if (!account.address || !account.publicKey) {
        throw new Error('Missing address or public key from wallet');
      }
      
      // Send the proof to the server for verification
      const response = await api.connectTonWallet(
        account.address,
        account.publicKey,
        proof,
        authToken || ''
      );
      
      // Handle successful connection
      if (response.data.statusCode === 200) {
        setConnected(true);
        // You might want to store wallet ID or perform additional actions
        console.log('TON wallet connected successfully:', response.data);
      }
    } catch (err: any) {
      setError(err.message || 'Failed to connect TON wallet');
      console.error('Error connecting TON wallet:', err);
      // Disconnect on error
      tonConnectUI.disconnect();
    } finally {
      setConnecting(false);
    }
  }, [tonConnectUI, authToken]);

  // Set up connection parameters when TON Connect is ready
  useEffect(() => {
    const setupTonConnect = async () => {
      try {
        // Generate payload for ton_proof
        const payload = await api.generatePayload();
        
        // Configure connection parameters with ton_proof request
        tonConnectUI.setConnectRequestParameters({
          state: 'ready',
          value: {
            tonProof: payload
          }
        });
      } catch (err) {
        console.error('Error setting up TON Connect:', err);
        setError('Failed to set up wallet connection');
      }
    };
    
    setupTonConnect();
  }, [tonConnectUI]);

  // Handle connection changes
  useEffect(() => {
    if (tonConnectUI.connected) {
      handleConnection();
    } else {
      setConnected(false);
    }
  }, [tonConnectUI.connected, handleConnection]);

  return (
    <div className="wallet-connect-container">
      <h2>Connect TON Wallet</h2>
      
      <TonConnectButton />
      
      {connecting && <p>Connecting your wallet...</p>}
      
      {connected && (
        <div className="wallet-connected">
          <p>Wallet connected!</p>
          <p>Address: {userFriendlyAddress}</p>
        </div>
      )}
      
      {error && (
        <div className="error-message">
          <p>Error: {error}</p>
        </div>
      )}
    </div>
  );
};

export default TonWalletConnect;
```

### 4. Set Up TON Connect Provider

In your main application file (e.g., `App.tsx` or `index.tsx`):

```tsx
import { TonConnectUIProvider } from '@tonconnect/ui-react';

// TON Connect manifest URL
const manifestUrl = 'https://yourdapp.com/tonconnect-manifest.json';

function App() {
  return (
    <TonConnectUIProvider manifestUrl={manifestUrl}>
      <div className="App">
        {/* Your app components */}
        <TonWalletConnect />
      </div>
    </TonConnectUIProvider>
  );
}

export default App;
```

### 5. Advanced Options: Network Selection

To work with testnet:

```tsx
import { TonConnectUIProvider } from '@tonconnect/ui-react';

function App() {
  return (
    <TonConnectUIProvider 
      manifestUrl={manifestUrl}
      actionsConfiguration={{
        // Set to TESTNET for development
        twaReturnUrl: window.location.href,
        skipRedirectToWallet: true,
        // Use appropriate network
        walletsListConfiguration: {
          includeTestnet: true,
        },
      }}
    >
      <div className="App">
        <TonWalletConnect />
      </div>
    </TonConnectUIProvider>
  );
}
```

### 6. Handling Wallets with Limited TON Proof Support

Some wallets might not fully support TON proof. In such cases, you can provide a fallback:

```tsx
// Inside your component
useEffect(() => {
  const setupTonConnect = async () => {
    try {
      const payload = await api.generatePayload();
      
      // Add fallback options if the wallet doesn't support ton_proof
      tonConnectUI.setConnectRequestParameters({
        state: 'ready',
        value: {
          // Primary method: ton_proof
          tonProof: payload,
          // Fallback: just connect without proof (will require additional verification)
          // You'll need to implement an alternative verification flow for these wallets
        }
      });
    } catch (err) {
      console.error('Error setting up TON Connect:', err);
    }
  };
  
  setupTonConnect();
}, [tonConnectUI]);
```

With this implementation, your frontend will be able to connect to TON wallets and verify ownership through the secure TON proof mechanism. 